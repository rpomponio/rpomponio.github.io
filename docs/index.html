<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>rpomponio.github.io - Work In Progress</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">rpomponio.github.io</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#modeling-the-timing-of-starting-pitcher-replacements-in-postseason-games-2023" id="toc-modeling-the-timing-of-starting-pitcher-replacements-in-postseason-games-2023" class="nav-link active" data-scroll-target="#modeling-the-timing-of-starting-pitcher-replacements-in-postseason-games-2023">Modeling the timing of starting pitcher replacements in postseason games (2023)</a>
  <ul class="collapse">
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#motivating-example" id="toc-motivating-example" class="nav-link" data-scroll-target="#motivating-example">Motivating Example</a></li>
  <li><a href="#methodology-overview" id="toc-methodology-overview" class="nav-link" data-scroll-target="#methodology-overview">Methodology Overview</a></li>
  <li><a href="#results-overview" id="toc-results-overview" class="nav-link" data-scroll-target="#results-overview">Results Overview</a></li>
  <li><a href="#conclusions-and-next-steps" id="toc-conclusions-and-next-steps" class="nav-link" data-scroll-target="#conclusions-and-next-steps">Conclusions and Next Steps</a></li>
  <li><a href="#methodology-details" id="toc-methodology-details" class="nav-link" data-scroll-target="#methodology-details">Methodology Details</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Work In Progress</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="modeling-the-timing-of-starting-pitcher-replacements-in-postseason-games-2023" class="level2">
<h2 class="anchored" data-anchor-id="modeling-the-timing-of-starting-pitcher-replacements-in-postseason-games-2023">Modeling the timing of starting pitcher replacements in postseason games (2023)</h2>
<p><em>The following work has been submitted for consideration at the 2024 SABR Analytics Conference in Phoenix, Arizona:</em> <a href="https://sabr.org/analytics">conference page</a>.</p>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>Recently a number of research papers have emerged examining the effects of starting pitcher replacements in Major League Baseball (MLB).<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> This past year, the time through the order penalty (TTOP) was analyzed in a Bayesian framework and results were published in the Journal of Quantiative Analysis in Sports.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> There remain many questions about starting pitcher strategies, particularly in the postseason when managers’ decisions are hyper-scrutinized.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Despite a trend towards earlier starting pitcher replacements in both regular season<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> and postseason<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> <a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> play, I am not aware of any analysis that has considered the replacement of the starting pitcher as a time-to-event phenomenon. The field of biostatistics has benefited greatly from the ability to model time-to-event outcomes, such as all-cause mortality, within a regression framework outlined by the late David Cox.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> Cox’s proportional hazards model is convenient for several reasons. It permits the formal modeling of a relationship between time and the event of interest; it incorporates covariates that increase or reduce the risk of the event; and, with modern software one can easily estimate the probability of an event occurring within a pre-specified time window. All of these characteristics are useful in the context of analyzing starting pitcher replacements. I will make the case that Cox’s model is more suitable for modeling pitcher replacements than alternative approaches using classification or supervised machine learning techniques.</p>
</section>
<section id="motivating-example" class="level3">
<h3 class="anchored" data-anchor-id="motivating-example">Motivating Example</h3>
<p>In game seven of the 2003 ALCS, the Red Sox held a two-run lead over the Yankees in the eighth inning when manager Grady Little visited the mound.<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> Starting pitcher Pedro Martínez was still in the game, with Hideki Matsui at the plate. Little decided to leave Martínez in for both Matsui and Jorge Posada, resulting in the loss of the lead and ultimately the game in 11 innings. At the time of Little’s mound visit, how likely was Martínez’s replacement? The model that is developed below suggests that Martínez would be pulled in <strong>60.4%</strong> of games with similar circumstances.</p>
</section>
<section id="methodology-overview" class="level3">
<h3 class="anchored" data-anchor-id="methodology-overview">Methodology Overview</h3>
<p>Other sabermetrics work has identified important in-game factors that predict a starter’s replacement, such as the strike count, pitch count, number of outs, total batters faced, and current home runs conceded. However, pitching replacements have not been modeled as time-to-event outcomes. Instead, they have been modeled as binary outcomes. The advantage of timing models is that the cumulative effect of time is inherent; certain factors can expedite, or delay, the timing of the event. This process is also more realistic than a binary outcomes process, which considers each event independently.</p>
<p>The first question in this analysis is, what is the unit of time? For studying outcomes in medicine, time is often measured in months or years. However, in a baseball game, no more than a few hours go by, and typically the starting pitcher is replaced mid-way through the game. I chose to use the number of <a href="https://www.mlb.com/glossary/standard-stats/batters-faced">batters faced</a> as the unit of time in this analysis. While this is not a measure of clock time, it is a measure of the number of opponents that the pitcher has faced. The higher the number of opponents, the more fatigued the pitcher will become. Alternatively one could consider the number of pitches thrown as the unit of time. I don’t see any issue with this, though pitcher replacements often happen between batter plate appearanced, and pitch-by-pitch data is much more granular, potentially complicating the analysis</p>
<p>For data, I used all postseason games from 2000-2019 (source: <a href="https://www.retrosheet.org/">RetroSheet.org</a>). There were several reasons for choosing these seasons and not including more recent seasons. First, the obvious complications of the COVID-19 pandemic make working with the 2020 postseason challenging. Secondly, a number of recent rule changes have been implemented which might influence the strategy around starting pitcher replacement, for example the pitch clock. Therefore I consider the 20-year window between 2000 and 2019 to be a relatively stable period of postseason play. Future work will have to revisit the same questions explored here and see if the underlying conclusions hold up in the modern era.</p>
<p>I used Cox’s proportional hazards modeling approach and controlled for in-game strikeout rate, pitching volume (pitches thrown per batter faced), runners in scoring position, and home runs conceded, as well as differences across season eras and leagues. All of the covariates included in the model were computed sequentially for each batter faced. In other words, I did not use data from later in the game to inform a covariate value earlier in the game. I grouped seasons into five-year eras (e.g., 2000-2004), then analyzed the time-to-replacement for all starting pitchers in the dataset.</p>
</section>
<section id="results-overview" class="level3">
<h3 class="anchored" data-anchor-id="results-overview">Results Overview</h3>
<p>I found that pitchers in the 2015-2019 era were far more likely to be replaced earlier in the game, versus their counterparts in previous seasons. Below is an illustration of the ‘survival probability’, or the probability of remaining in the game for a starting pitcher from four different eras. It is clear that in the most-recent era (the purple line), starting pitchers had lower probabilities of remaining in the game at each number of batters faced (TBF). The p-value printed in the lower left is a result of comparing the four curves and assessing whether one or more curves differs from the rest. It is apparent that the difference in ‘survival’ in the 2015-2019 era, versus previous eras, was statistically significant.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Kaplan-Meier Postseason Starters.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Kaplan Meier curves illustrating probabilities of remaining in-game for starting pitchers in postseason games 2000-2019. The result of the log-rank test suggests a difference across season-eras.</figcaption>
</figure>
</div>
<p>Below are the model estimates for the effect of each covariate. For example, the Cox adjusted Hazard Ratio of Season era 2015-2019 (versus 2000-2004) was 2.69 (95% CI: 2.29 – 3.16). This means that starting pitchers in the most-recent era were 169% more likely to be replaced against any given batter, versus the 2000-2004 era. The relatively narrow confidence interval tells us that the estimated hazard ratio is reliable, i.e., if we were to replay history we would likely obtain a similar estimate.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Cox Adjusted Model.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Estimated hazard ratios for the ‘replacement factors’ of starting pitchers. The replacement factors are thought to influence the timing of pitcher replacements in the postseason. A hazard ratio greater than one indicates a higher likelihood of pitcher replacement.</figcaption>
</figure>
</div>
<p>To illustrate the magnitude of the season-era effect, consider a hypothetical pitcher playing in both the 2000-2004 and the 2000-2019 eras. Assuming typical starter performance (3.8 pitches per batter faced, strikeout rate of 20%), this pitcher has a 70.3% chance of pitching a third time through the order in 2000-2004 but only a 38.8% chance of doing so in 2015-2019. With a runner in scoring position, these probabilities decline to 60.5% and 25.8%, respectively (with one home run conceded, the probabilities are similar). The probabilities below reflect the two scenarios, with the baseline scenario being no runners in scoring position (RISP) and no home runs conceded.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Cox Predicted Probabilities.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption">Predicted probabilities of pitching a third time through the order for two hypothetical pitchers. The only difference between the pitchers is the era in which they play. The RISP scenario means at least one runner is in scoring position.</figcaption>
</figure>
</div>
</section>
<section id="conclusions-and-next-steps" class="level3">
<h3 class="anchored" data-anchor-id="conclusions-and-next-steps">Conclusions and Next Steps</h3>
<p>This work quantifies trends in starting pitcher replacements that have been formerly described, but not modeled in a time-to-event fashion. We can conclude that the strategy around starting pitcher replacement has been changing over the past 20 years of postseason play, since the effect of season-era is so significant. On the contrary, the use of the DH did not substantially alter the chance of pulling the starter when comparing managerial decisions across leagues.</p>
<p>Aside from the apparent trend of earlier staring pitcher replacements, there are several factors that indicate a meaningful impact on managerial strategy. For example, pitchers throwing more than 3.8 pitches per batter faced were more likely to be pulled (each additional pitch thrown per batter was associated with 127% higher chance of replacement). Similarly, a pitcher throwing to an opposite-handed batter was more likely to be pulled. Lastly, pitchers generating more than a 20% in-game strikeout rate were less likely to be pulled (each additional 10 percentage-point increase in K rate was associated with 28% lower chance of replacement).</p>
<p>The model has drawbacks, in that it does not capture head-to-head matchup history or differing styles of management. Those factors can be included in future work. First, for head-to-head matchup history, it would likely encompass an estimate of the <a href="https://www.mlb.com/glossary/standard-stats/on-base-percentage">on-base percentage</a> of the batter against the specific pitcher in-question, observed during in the regular season of that same year. Ideally, this metric would be robust to small sample sizes, which are common when two opponents do not face each other very often in a season. The best framework for this would be an empirical Bayes estimate of head-to-head OBP.<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a></p>
<p>Secondly, for managerial styles, it would make sense to specify a random effect to account for correlated outcomes from decisions made by the same manager. In other words, some managers would be likely to pull the starter early; others may have a tendency to leave him in. This involves a more advanced modeling approach but it is still possible within the broader Cox proportional hazards framework. An analysis that accounts for managerial styles would offer empirical evidence of any trends among certain managers that have been observed by the sports commentary community.</p>
</section>
<section id="methodology-details" class="level3">
<h3 class="anchored" data-anchor-id="methodology-details">Methodology Details</h3>
<p>Postseason play-by-play data was downloaded from RetroSheet’s <a href="https://www.retrosheet.org/game.htm#Post-Season%20Games">postseason event files</a>. In total, 611 games were included. Postseason rosters indicated the batting and throwing handedness of individual players. The use of a designated hitter was determined by the starting roster for each game.</p>
<p>The play-by-play data contain one row per ‘play’, where a play constitutes either a base-running event or a ball put into play by the batter (or both). To make data wrangling more manageable, all offesnive plays after the replacement of the opponent starting pitcher were discarded; this was done separately for each team. For the start of each batter’s plate appearance, several key factors were determined:</p>
<ul>
<li>Batter handedness: same as pitchers (yes/no)</li>
<li>Runners in scoring position (yes/no)</li>
<li>Number of pitches thrown by stater (e.g., 0, 1, 2, …)</li>
<li>Homeruns conceded by starter in the game</li>
<li>Pitcher strikeout rate in the game (e.g., 20%)</li>
</ul>
<p>Importantly, the above factors were determined without knowledge of the outcome of the batter’s plate appearance. Thus, the information used in modeling simulates all information available to a manager in deciding whether to replace a pitcher at the start of an at-bat.</p>
<p>The factors used to predict the replacement of a starting pitcher were called ‘replacement factors.’ In this analysis, only a limited set of replacement factors were considered. Note the average pitching volume was 3.8 pitches per batter faced; the average strikeout rate was 20%. To aid interpretability, the replacement factors for pitching volume and strikeout rate were centered at zero, therefore a positive value for either factor represents above-average.Above-average pitching volume is generally considered worse performance, as the pitcher must throw more times to the opponent and is expected to fatigues earlier. In contrast, above-average strikeout rate indicates elevated performance.</p>
<p>Of the 1,218 starting pitching performances in the dataset, only 33 (2.7%) included complete game performances; complete games are very rare but not unheard of in the postseason.<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> Fortunately the Cox proportional hazards framework does not require discarding complete games, even though the starting pitcher was never replaced. Instead, this is considered a <a href="https://en.wikipedia.org/wiki/Censoring_(statistics)#:~:text=In%20statistics%2C%20censoring%20is%20a,(but%20may%20be%20more).">censored</a> observation, where we know that the pitcher remained in the game for its entirety. The underlying assumption is that the pitcher <em>would have been</em> replaced, for example if the game extended into extra innings. This is not an unreasonable assumption as even the best-throwing pitchers will eventually fatigue and need relief, if for no other reason than injury management.</p>
<hr>


</section>
</section>


<p>Links: <a href="https://github.com/rpomponio">GitHub</a> | <a href="https://scholar.google.com/citations?user=TxEcZMMAAAAJ&amp;hl=en">Google Scholar</a></p><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>G. Ganeshapillai and J. Guttag, “A Data-driven Method for In-game Decision Making in MLB,” MIT Sloan Sports Analytics Conference, vol.&nbsp;8, 2014.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>M. Woodham, J. Hawkins, A. Singh and S. Chakraborty, “When to Pull Starting Pitchers in Major League Baseball? A Data Mining Approach,” IEEE International Conference On Machine Learning And Applications, vol.&nbsp;18, pp.&nbsp;426-431, 2019.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>D. Finigan, B. M. Mills and D. F. Stone, “Pulling starters,” Journal of Behavioral and Experimental Economics, vol.&nbsp;89, 2020.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Brill, R., Deshpande, S. &amp; Wyner, A. “A Bayesian analysis of the time through the order penalty in baseball.” Journal of Quantitative Analysis in Sports, 19(4), 245-262, 2023.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>J. Stark, “The book on hooks,” ESPN.com Baseball, 10 May 2004. [Online]. Available: https://www.espn.com/. [Accessed November 2023].<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>R. Houston, “Call to the Bullpen: More Often and More Effective,” Samford University, 20 April 2018. [Online]. Available: https://www.samford.edu/sports-analytics. [Accessed November 2023].<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>M. Orwin and C. Tien, “Call to the Bullpen: The Increase in MLB Reliever Usage,” Bruin Sports Analytics, 31 March 2022. [Online]. Available: https://www.bruinsportsanalytics.com/. [Accessed November 2023].<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>J. Jaffe, “Postseason Starting Pitching Ain’t What It Used to Be, After All,” FanGraphs, 27 October 2023. [Online]. Available: https://blogs.fangraphs.com/. [Accessed November 2023].<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>J. Jaffe, “The Incredible Shrinking Postseason Starter,” FanGraphs, 18 October 2021. [Online]. Available: https://blogs.fangraphs.com/. [Accessed November 2023].<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>J. D. Kalbfleisch and D. E. Schaubel, “Fifty Years of the Cox Model,” Annual Review of Statistics and Its Application, vol.&nbsp;10, pp.&nbsp;1-23, 2023.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>J. D. Kalbfleisch and D. E. Schaubel, “Fifty Years of the Cox Model,” Annual Review of Statistics and Its Application, vol.&nbsp;10, pp.&nbsp;1-23, 2023.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>A. Landgraf, “Empirical Bayes Estimation of On Base Percentage,” R-bloggers, 30 December 2010 [Online]. Available: https://www.r-bloggers.com/2010/12/empirical-bayes-estimation-of-on-base-percentage/. [Accessed December 2023].<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>L. Shenk, “Looking back at Doc’s postseason no-no,” MLB.com, 13 October 2022 [Online]. Available: https://www.mlb.com/news/roy-halladay-s-playoff-no-hitter-remembered. [Accessed December 2023].<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>